name: Build @cryptlex/lexactivator package

on:
  workflow_dispatch:

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  # Link LexActivator static libs to Node
  build-addons:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            job-type: linux
          - os: macos-14-large
            job-type: macos
          - os: windows-2022
            node-version: 10
            job-type: windows-node10
          - os: windows-2022
            node-version: 20
            job-type: windows-node20
    steps:
      - uses: actions/checkout@v2

      - run: git pull origin master --ff-only

      - name: Setup Node.js v1
        if: matrix.os != 'windows-2022'
        uses: actions/setup-node@v1
        with:
          node-version: 10

      # - name: Install Windows 2015 build tools
      #   if: matrix.os == 'windows-2019'
      #   run: npm i --global windows-build-tools --vs2015

      - name: Windows 2022 Node 10 installation
        if: matrix.os == 'windows-2022' && matrix.job-type == 'windows-node10'
        uses: actions/setup-node@v1
        with:
            node-version: 10

      - name: Build for Windows 32bit and 64bit (Node 10)
        if: matrix.os == 'windows-2022' && matrix.job-type == 'windows-node10'
        shell: powershell
        run: |
          npm i -g node-gyp@8
          .\scripts\build-windows.ps1
      
      - name: Windows 2022 Node 20 installation
        if: matrix.os == 'windows-2022' && matrix.job-type == 'windows-node20'
        uses: actions/setup-node@v4
        with:
            node-version: 20

      - name: Build for Windows ARM64 (Node 20)
        if: matrix.os == 'windows-2022' && matrix.job-type == 'windows-node20'
        shell: powershell
        run: |
          npm i -g node-gyp@10
          .\scripts\build-windows-arm64.ps1
      
      - name: Build for macOS
        if: matrix.os == 'macos-14-large'
        run: |
          npm i -g node-gyp@8
          ./scripts/build-macos.sh

      - name: Build for Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          docker run -t -v $PWD:$PWD -w $PWD cryptlex/gcc-4.9:1 ./scripts/build-linux.sh
          docker run -t -v $PWD:$PWD -w $PWD cryptlex/gcc-4.9-arm:1 ./scripts/build-linux-arm.sh
          docker run -t -v $PWD:$PWD -w $PWD cryptlex/alpine-builder:2 ./scripts/build-linux-musl.sh
          docker run -t -v $PWD:$PWD -w $PWD cryptlex/alpine-builder-arm:1 ./scripts/build-linux-musl-arm.sh

      - name: 'Upload artifacts'
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{matrix.job-type}}
          path: |
            ./lib/bindings/linux/**/**/*.node
            ./lib/bindings/macos/**/*.node
            ./lib/bindings/windows/**/*.node
            ./lib/bindings/windows/**/*.dll
          retention-days: 1
  
  # Publish to NPM
  publish-npm:
    needs: build-addons
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v3
        with:
          node-version: 16
          registry-url: https://registry.npmjs.org/
      - run: git pull origin master --ff-only

      - name: 'Download artifacts'
        uses: actions/download-artifact@v4
        with:
          path: ./lib/bindings
          merge-multiple: true

      - name: 'Build library'
        run: |
          npm ci
          npm run build

      # Switch to Node 22 and update npm for publishing
      - uses: actions/setup-node@v3
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      # Ensure npm 11.5.1+ is installed (required for OIDC authentication)
      - name: Update npm
        run: npm install -g npm@latest

      - name: 'Publish to NPM'
        run: npm publish --access public
